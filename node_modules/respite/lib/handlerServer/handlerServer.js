var http = require('http');

var pageAction = require("./pageAction.js");
var weinreAppendHandler = require("./weinreAppendHandler/weinreAppendHandler.js");

var handlePage = function(body, config, url,resHeaders) {
	if (resHeaders["content-type"] != "text/html") {
		return body;
	}
	// weinre handle
	try {
		body = weinreAppendHandler.handle(body, config);
	} catch (e) {
		console.log(('[info] error happen when parse html: ' + e + '!').red);
		console.log("[info] url: " + req.url);
		return body;
	}
	// other self-defined handlers
	var pageHandlers = config.proxy.pageHandlers || [];
	for (var i = 0; i < pageHandlers.length; i++) {
		var pageHandler = pageHandlers[i];
		pageHandler = require(pageHandler);
		if (pageHandler) {
			body = pageHandler.handle(body);
		}
	}
	return body;
}

module.exports = {
	createServer: function(config) {
		// create server
		http.createServer(function(req, res) {
			var hostName = req.headers["host"].split(":")[0];
			var port = req.headers["host"].split(":")[1] || 80;

			hostName = req.headers["fiddlerhostname"] || hostName;
			port = req.headers["fiddlerport"] || port;

			if (!hostName || !port) {
				res.end("Missing hostname or port from proxy server!");
				return;
			}
			req.headers["fiddlerpass"] = "pass";
			req.headers["host"] = hostName + ":" + port;
			delete req.headers["accept-encoding"];

			pageAction(req, res, {
				handleBody: function(body, resHeaders) {
					return handlePage(body, config, req.url, resHeaders);
				}
			});
		}).listen(config.handlerServer.port);

		console.log('[info] local background server running at port ' + config.handlerServer.port + '!');
	}
}