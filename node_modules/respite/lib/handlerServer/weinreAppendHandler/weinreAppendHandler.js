var cheerio = require("cheerio");
var fs = require('fs');
var path = require("path");
var localIpFetcher = require("../../localIpFetcher.js");

var weinreRemoteCodePath = path.join(__dirname, "./weinreRemoteCode.jst");

var getRemoteCode = function(port) {
	var ip = localIpFetcher.getIPAdress();
	port = port || 8081;
	var code = fs.readFileSync(weinreRemoteCodePath, "utf-8");
	code = code.replace(/"\{\{ip\}\}"/g, '"' + ip + '"');
	code = code.replace(/"\{\{port\}\}"/g, port);
	return code;
}

module.exports = {
	handle: function(body, config) {
		var $ = cheerio.load(body);
		var port = config.debug.weinre.port;
		$("head").prepend("<script>" + getRemoteCode(port) + "</script>");
		return $.html();
	}
}